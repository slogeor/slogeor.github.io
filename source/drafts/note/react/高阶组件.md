---
title:  高阶组件
categories: note
tags: #文章標籤 可以省略
     - react
---

### 无状态组件 (Stateless Component)
```js
function HelloComponent(props, /* context */) {
  return <div>Hello {props.name}</div>
}
ReactDOM.render(<HelloComponent name="Sebastian" />, mountNode)
```

HelloComponent 组件的第一个参数是 `props`，第二个是 `content`。
结合 ES6 的解构赋值，可以让代码更精简。例如下面这个 Input 组件：

```js
function Input({ label, name, value, ...props }, { defaultTheme }) {
  const { theme, autoFocus, ...rootProps } = props
  return (
    <label
      htmlFor={name}
      children={label || defaultLabel}
      {...rootProps}
    >
    <input
      name={name}
      type="text"
      value={value || ''}
      theme={theme || defaultTheme}
      {...props}
    />
  )}
Input.contextTypes = {defaultTheme: React.PropTypes.object};
```

### 无状态组件与组件的生命周期方法

无状态组件只剩下一个 `render` 方法，因此无法实现组件的生命周期方法。如果我们想要让我们的 `Input` 组件能够响应窗口大小的变化，需要引入有状态的组件，只不过这个有状态的组件不仅仅为 Input 组件服务。

```js
const ExecutionEnvironment = require('react/lib/ExecutionEnvironment')
let viewport = { width: 1366, height: 768 }; // Default size for server-side rendering

function handleWindowResize() {
  if (viewport.width !== window.innerWidth || viewport.height !== window.innerHeight) {
    viewport = { width: window.innerWidth, height: window.innerHeight }
  }
}

function withViewport(ComposedComponent) {
  return class Viewport extends React.Component {
    state = {
      // Server 端渲染和单元测试的时候可未必有 DOM 存在
      viewport: ExecutionEnvironment.canUseDOM ?
        { width: window.innerWidth, height: window.innerHeight } : viewport
    }
    componentDidMount() {
      // Server 端渲染是不会执行到 `componentDidMount` 的，只会执行到 `componentWillMount`
      window.addEventListener('resize', handleWindowResize)
      window.addEventListener('orientationchange', handleWindowResize)
    }
    componentWillUnmount() {
      window.removeEventListener('resize', handleWindowResize)
      window.removeEventListener('orientationchange', handleWindowResize)
    }
    render() {
      return <ComposedComponent {...this.props} viewport={this.state.viewport}/>
    }
  }
}
```

创建一个有机会响应窗口大小变化的 Input 组件。

```js
const SizeableInput = withViewport(Input)
ReactDOM.render(<SizeableInput name="username" label="Username" {...props} />, mountNode)
```

`withViewport` 作为一个高阶组件，可不仅仅是为了 Input 组件服务。它可以为你需要任何组件添加 `viewport` 属性，当窗口大小变化时，触发重绘。

高阶组件存在的好处：
* 当写无状态组件的时候，有一天发现需要处理状态，那么无需彻底返工
* 往往我们需要状态的时候，这个需求是可以复用的

高阶组件加上无状态组件，大大增强整个代码的可测试 性和可维护性。

### 无状态组件不支持 ref
React 调用到无状态组件的方法之前，没有一个实例化的过程的，因此也就没有所谓的 ref。

` ref ` 和 `findDOMNode` 这个组合，打破了父子组件之间仅仅通过 `props` 来传递状态的约定，是危险且肮脏，需要避免。

### 高阶组件

高阶组件就是一个 React 组件包裹着另外一个 React 组件

这种模式通常使用函数来实现，基本上是一个类工厂（是的，一个类工厂！），它的函数签名可以用类似 haskell 的伪代码表示

```js
hocFactory:: W: React.Component => E: React.Component
```
其中 W (WrappedComponent) 指被包裹的 React.Component，E (EnhancedComponent) 指返回类型为 React.Component 的新的 HOC。
### 高阶组件和 mixin

![https://user-gold-cdn.xitu.io/2017/5/12/f0f5b214d08abc1a1ac88dd0e006b611](https://user-gold-cdn.xitu.io/2017/5/12/f0f5b214d08abc1a1ac88dd0e006b611)

高阶组件属于函数式编程(functional programming)思想，对于被包裹的组件时不会感知到高阶组件的存在，而高阶组件返回的组件会在原来的组件之上具有功能增强的效果。而Mixin这种混入的模式，会给组件不断增加新的方法和属性，组件本身不仅可以感知，甚至需要做相关的处理(例如命名冲突、状态维护)，一旦混入的模块变多时，整个组件就变的难以维护，也就是为什么如此多的React库都采用高阶组件的方式进行开发。

高阶组件其实就是为了组件之间的代码复用。组件可能有着某些相同的逻辑，把这些逻辑抽离出来，放到高阶组件中进行复用。高阶组件内部的包装组件和被包装组件之间通过 props 传递数据。

### 高阶组件实现方法

* Props Proxy
* Inheritance Inversion

##### Props Proxy

HOC 对传给 WrappedComponent W 的 porps 进行操作

* 操作 props
* 通过 Refs 访问到组件实例
* 提取 state
* 用其他元素包裹 WrappedComponent

##### Inheritance Inversion
HOC 继承 WrappedComponent W

* 一致化处理
* 渲染劫持
* 操作 state

#### 忠告

* 不要在 render 方法内使用 HOC
* 静态方法需要被复制
* ref 不被传递

### 总结

* 高阶组件就是一个函数，传给它一个组件，它返回一个新的组件。新的组件使用传入的组件作为子组件。
* 高阶组件的作用是用于代码复用，可以把组件之间可复用的代码、逻辑抽离到高阶组件当中。新的组件和传入的组件通过 props 传递信息。
* 高阶组件有助于提高我们代码的灵活性，逻辑的复用性。

### 参考链接

* [https://zhuanlan.zhihu.com/p/24776678](https://zhuanlan.zhihu.com/p/24776678)
* [http://huziketang.com/books/react/lesson28](http://huziketang.com/books/react/lesson28)
* [https://github.com/ecmadao/Coding-Guide/blob/master/Notes/React/ReactJS](https://github.com/ecmadao/Coding-Guide/blob/master/Notes/React/ReactJS/%20%E3%80%90%E8%AF%91%E3%80%91React%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6.md)
* [https://juejin.im/post/595243d96fb9a06bbd6f5ccd](https://juejin.im/post/595243d96fb9a06bbd6f5ccd)
